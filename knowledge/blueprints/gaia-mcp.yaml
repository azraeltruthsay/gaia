# gaia-mcp blueprint — MANUAL SEED (bootstrap)
# Hand-authored from codebase audit (2026-02-17).
# Covers ~95% of gaia-mcp's actual surface area as of commit d589a85.
# generated_by: manual_seed | genesis: true until first reflection cycle validates it.

id: gaia-mcp
version: "0.5"
role: "The Hands (Tool Execution)"
service_status: live

runtime:
  port: 8765
  base_image: python:3.11-slim
  gpu: false
  startup_cmd: "uvicorn gaia_mcp.main:app --host 0.0.0.0 --port 8765"
  health_check: "curl -f http://localhost:8765/health"
  user: "${UID}:${GID}"
  dockerfile: gaia-mcp/Dockerfile
  compose_service: gaia-mcp

interfaces:

  # ── Inbound ────────────────────────────────────────────────────────────────

  - id: health
    direction: inbound
    description: "Container health check endpoint."
    status: active
    transport:
      type: http_rest
      path: /health
      method: GET

  - id: root
    direction: inbound
    description: "Root endpoint — returns running status message."
    status: active
    transport:
      type: http_rest
      path: /
      method: GET

  - id: jsonrpc_dispatch
    direction: inbound
    description: "Primary tool dispatch via JSON-RPC 2.0. Handles ~30 tool methods: file I/O (read_file, write_file, ai_write), shell (run_shell), memory/vector (memory_query, memory_rebuild_index), web research (web_search, web_fetch), fragments, study gateway, Discord messaging."
    status: active
    transport:
      type: http_rest
      path: /jsonrpc
      method: POST

  - id: request_approval
    direction: inbound
    description: "Create pending approval for sensitive tool (ai_write, write_file, run_shell, memory_rebuild_index). Returns action_id + 5-char challenge."
    status: active
    transport:
      type: http_rest
      path: /request_approval
      method: POST

  - id: pending_approvals
    direction: inbound
    description: "List all pending approvals awaiting human confirmation."
    status: active
    transport:
      type: http_rest
      path: /pending_approvals
      method: GET

  - id: approve_action
    direction: inbound
    description: "Approve pending action by providing reversed 5-char challenge. Dispatches underlying tool on success."
    status: active
    transport:
      type: http_rest
      path: /approve_action
      method: POST

  # ── Outbound ───────────────────────────────────────────────────────────────

  - id: study_gateway
    direction: outbound
    description: "Async HTTP gateway to gaia-study for LoRA training and adapter management."
    status: active
    transport:
      type: http_rest
      path: /study/start
      method: POST

  - id: web_research
    direction: outbound
    description: "External web research via DuckDuckGo (ddgs library with Instant Answer API fallback). Rate-limited: 20 searches/hr, 50 fetches/hr."
    status: active
    transport:
      type: http_rest
      path: /
      method: GET

  - id: discord_webhook
    direction: outbound
    description: "Optional Discord webhook for send_discord_message tool. Requires DISCORD_WEBHOOK_URL env var."
    status: active
    transport:
      type: http_rest
      path: /
      method: POST

dependencies:
  services:
    - id: gaia-study
      role: lora_training_and_adapter_management
      required: false
      fallback: null

  volumes:
    - name: gaia-common
      access: ro
      purpose: "Shared library (tools registry, config, utils)"
      mount_path: /gaia-common
    - name: knowledge
      access: rw
      purpose: "Tool reference docs, system knowledge base, vector index"
      mount_path: /knowledge
    - name: gaia-models
      access: ro
      purpose: "LoRA adapters, embedding models"
      mount_path: /models
    - name: gaia-sandbox
      access: rw
      purpose: "Isolated workspace for tool execution"
      mount_path: /sandbox

  external_apis:
    - name: duckduckgo
      purpose: web_search_and_fetch
      required: false
    - name: discord
      purpose: webhook_messaging
      required: false

source_files:
  - path: candidates/gaia-mcp/gaia_mcp/main.py
    role: entrypoint
    file_type: python
  - path: candidates/gaia-mcp/gaia_mcp/server.py
    role: core_dispatcher
    file_type: python
  - path: candidates/gaia-mcp/gaia_mcp/approval.py
    role: approval_gate
    file_type: python
  - path: candidates/gaia-mcp/gaia_mcp/web_tools.py
    role: web_research
    file_type: python
  - path: candidates/gaia-mcp/Dockerfile
    role: build_config
    file_type: dockerfile

failure_modes:
  - condition: "Tool execution error"
    response: "JSON-RPC error response with code -32603 and traceback in data field"
    severity: degraded
    auto_recovers: false

  - condition: "Approval timeout (>900s default TTL)"
    response: "Pending action expires; client must request approval again"
    severity: degraded
    auto_recovers: true

  - condition: "File path not in allowlist"
    response: "ValueError; JSON-RPC error -32603 'Path not allowed'"
    severity: degraded
    auto_recovers: false

  - condition: "Rate limit exceeded (web_search/web_fetch)"
    response: "Returns ok=false with remaining count; auto-recovers after sliding window"
    severity: degraded
    auto_recovers: true

  - condition: "Blocked or unknown domain in web_fetch"
    response: "Returns ok=false with domain policy error"
    severity: degraded
    auto_recovers: false

  - condition: "gaia-study unavailable"
    response: "study_* and adapter_* tools return ok=false with error message"
    severity: degraded
    auto_recovers: false

  - condition: "Sensitive tool without prior approval"
    response: "HTTP 403 with JSON-RPC error directing to /request_approval"
    severity: degraded
    auto_recovers: false

intent:
  purpose: >
    Sandboxed execution layer enforcing security boundaries around GAIA's tool
    calls. Acts as both a security perimeter (preventing unauthorized file/shell
    access via path allowlisting) and an approval gate (requiring human
    confirmation for destructive operations). Delegation to a separate service
    allows gaia-core to remain interface-agnostic and CPU-only.
  cognitive_role: "The Hands"
  design_decisions:
    - "Separate service decouples tool execution from cognition, keeping gaia-core CPU-only"
    - "Path allowlisting restricts file ops to /knowledge, /sandbox, /models; symlink traversal blocked via .resolve()"
    - "Approval flow enforces human-in-the-loop via 5-char challenge reversal; time-boxed to configurable TTL"
    - "Domain allowlisting gates web research to trusted/reliable tiers; blocked list prevents social media leakage"
    - "Rate limiting (20 searches/hr, 50 fetches/hr) via in-memory sliding window prevents abuse"
    - "Study gateway pattern (async await) enables LoRA adapter management while preserving tool isolation"
    - "Fragment assembly with overlap checking enables long responses split across token limits"
    - "JSON-RPC 2.0 for lightweight tool dispatch without REST overhead"
    - "Graceful degradation: missing study, blocked domains, rate limits return structured errors not exceptions"
  open_questions:
    - "Should approval TTL be configurable per-tool (e.g., ai_write longer than run_shell)?"
    - "Should rate limits be per-minute with burst allowance instead of per-hour?"
    - "Should approval store persist to disk across container restarts for auditability?"

meta:
  status: candidate
  genesis: true
  generated_by: manual_seed
  blueprint_version: "0.2"
  schema_version: "1.0"
  last_reflected: null
  promoted_at: null
  confidence:
    runtime: high
    contract: high
    dependencies: high
    failure_modes: medium
    intent: medium
  reflection_notes: null
  divergence_score: null

architecture:
  components:

    - id: jsonrpc_server
      label: "JSON-RPC Server"
      description: >
        FastAPI application implementing the MCP (Model Context Protocol)
        JSON-RPC dispatch. Receives tool call requests from gaia-core,
        validates parameters, routes to the appropriate tool implementation,
        and returns structured results. Implements the /jsonrpc POST endpoint
        and root discovery endpoint.
      source_files:
        - candidates/gaia-mcp/gaia_mcp/server.py
        - candidates/gaia-mcp/gaia_mcp/main.py
      key_functions:
        - "create_app()"
        - "read_root()"
      exposes_interfaces:
        - jsonrpc
        - health
        - root

    - id: tool_registry
      label: "Tool Registry"
      description: >
        Tool catalog and implementations. Provides list_tools() for
        discovery and describe_tool() for schema inspection. Implements
        file I/O tools (read, write, list, find), memory tools (query,
        status, rebuild_index), fragment assembly tools (write, read,
        assemble, list_pending, clear), and the AI-assisted write tool
        that uses the rescue helper for context-aware file operations.
      source_files:
        - candidates/gaia-mcp/gaia_mcp/tools.py
      key_functions:
        - "list_tools()"
        - "describe_tool()"
        - "_ai_write_impl()"
        - "_read_file_impl()"
        - "_write_file_impl()"
        - "_memory_query_impl()"
        - "_find_relevant_documents()"
        - "_fragment_assemble_impl()"

    - id: approval_gate
      label: "Approval Gate"
      description: >
        Security-critical action approval workflow. Generates time-limited
        challenges for sensitive operations (file writes, shell execution).
        ApprovalStore tracks pending actions with TTL-based expiry.
        Challenge-response pattern prevents automated bypass of the
        approval requirement.
      source_files:
        - candidates/gaia-mcp/gaia_mcp/approval.py
      key_classes:
        - "ApprovalStore"
      key_functions:
        - "ApprovalStore.create_pending()"
        - "ApprovalStore.approve()"
        - "ApprovalStore.cancel()"
        - "ApprovalStore.cleanup_expired()"
      exposes_interfaces:
        - request_approval
        - approval_status

    - id: web_tools
      label: "Web Search & Fetch"
      description: >
        Web access tools with domain trust tier system. SourceTrustConfig
        classifies domains into trust tiers (trusted, standard, blocked).
        Rate limiter prevents abuse. Implements DuckDuckGo search and
        HTTP content fetching with HTML-to-text extraction. Content is
        filtered by domain trust level before returning to the caller.
      source_files:
        - candidates/gaia-mcp/gaia_mcp/web_tools.py
      key_classes:
        - "SourceTrustConfig"
        - "_RateLimiter"
      key_functions:
        - "web_search()"
        - "web_fetch()"
        - "SourceTrustConfig.tier_for_domain()"
        - "SourceTrustConfig.is_allowed()"

  edges:
    - from_component: jsonrpc_server
      to_component: tool_registry
      label: "dispatches tool calls to"
      data_flow: "method name + params → result"

    - from_component: jsonrpc_server
      to_component: approval_gate
      label: "checks approval for sensitive operations"
      data_flow: "action_type, description, params"

    - from_component: tool_registry
      to_component: approval_gate
      label: "requests approval before write/execute"
      data_flow: "pending action → challenge"

    - from_component: tool_registry
      to_component: web_tools
      label: "delegates web_search/web_fetch calls"
      data_flow: "search query or URL → content"
