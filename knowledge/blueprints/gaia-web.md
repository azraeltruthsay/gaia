# GAIA Service Blueprint: `gaia-web` (The Face (Web/Discord Gateway))

> **Status:** ðŸŸ¢ LIVE Â· âš ï¸ genesis â€” awaiting validation  
> **Service version:** 0.5  
> **Blueprint version:** 0.2  
> **Generated by:** `manual_seed`  
> **Last reflected:** never  

## Purpose

The user-facing gateway of GAIA. Handles all external interactions: web form submissions, Discord messaging (mentions + DMs), and output routing back to endpoints. Integrates sleep/wake coordination: enqueues messages while GAIA sleeps, wakes on first message, polls for active state before returning response.


**Cognitive role:** The Face

### Design Decisions

- FastAPI + uvicorn for concurrent Discord and web traffic
- Discord bot runs in background thread (separate event loop) to avoid blocking HTTP handlers
- Sleep-aware message queue holds incoming messages while GAIA sleeps, sends wake signal, waits for active
- Direct Discord bot control: /presence and /output_router directly manipulate discord.py bot
- Message splitting respects Discord's 2000-char limit while preferring newline/word boundaries
- gaia-core is the single source of truth for sleep state; web polls rather than caches
- Graceful degradation: Discord unavailability doesn't block web API

### âš ï¸ Open Questions

- Should message queue persistence survive service restart, or is in-memory-only acceptable?
- Is MessageQueue polling interval (1.5s default) optimal, or should it be configurable?
- Should /output_router handle async retries for failed Discord sends?

## Runtime

| Property | Value |
|----------|-------|
| Port | `6414` |
| Base image | `python:3.11-slim` |
| GPU | No |
| Health check | `curl -f http://localhost:6414/health` |
| Startup | `uvicorn gaia_web.main:app --host 0.0.0.0 --port 6414` |
| User | `${UID}:${GID}` |
| Dockerfile | `gaia-web/Dockerfile` |
| Compose service | `gaia-web` |

## Interfaces

### Inbound

- **`health`** âœ… `http_rest` `/health`  
  Container health check endpoint.
- **`root`** âœ… `http_rest` `/`  
  Root endpoint â€” returns service info and available endpoints for discovery.
- **`queue_status`** âœ… `http_rest` `/queue/status`  
  Message queue telemetry â€” queued count, wake signal state, oldest message age.
- **`process_user_input`** âœ… `http_rest` `/process_user_input`  
  Primary user input entry point. Receives text from web/Discord, converts to CognitionPacket, sends to gaia-core. Sleep-aware: enqueues + wakes + polls if GAIA is asleep.
- **`presence`** âœ… `http_rest` `/presence`  
  Update Discord bot presence (status dot + activity text). Called by gaia-core's SleepCycleLoop.
- **`output_router`** âœ… `http_rest` `/output_router`  
  Route completed packets to output destinations (Discord channels, DMs, logs). Called by gaia-core after response generation.

### Outbound

- **`core_process_packet`** âœ… `http_rest` `/process_packet`  
  Send CognitionPacket to gaia-core for cognitive processing.
- **`core_sleep_distracted_check`** âœ… `http_rest` `/sleep/distracted-check`  
  Check gaia-core sleep state before enqueueing messages.
- **`core_sleep_wake`** âœ… `http_rest` `/sleep/wake`  
  Send wake signal to gaia-core. Triggers ASLEEP -> WAKING transition.
- **`core_sleep_status`** âœ… `http_rest` `/sleep/status`  
  Poll gaia-core sleep status in wait_for_active loop.
- **`discord_bot`** âœ… `direct_call` `gaia_web.discord_interface.DiscordInterface`  
  discord.py bot instance â€” sends/receives Discord messages in background thread.

## Service Dependencies

- **`gaia-core`** â€” cognitive_processing Â· required

## External API Dependencies

- **discord** â€” bot_messaging_gateway Â· optional

## Volume Dependencies

- **gaia-common** `ro` â†’ `/gaia-common` â€” Shared library (CognitionPacket, protocols)
- **knowledge** `ro` â†’ `/knowledge` â€” Static knowledge base, blueprints, semantic codex

## Failure Modes

- ðŸ”´ **gaia-core unavailable**
  â†’ HTTP 503/504 returned to client; timeout after 300s
- ðŸŸ¡ **Discord bot token missing or invalid**
  â†’ Discord integration disabled; web input processing still works
- ðŸŸ¡ **Discord bot websocket down**
  â†’ /output_router returns 503 for Discord sends; bot auto-reconnects via discord.py
- ðŸŸ¡ **Sleep/wake queue timeout**
  â†’ wait_for_active times out; user gets timeout error
- ðŸŸ¡ **Discord message send fails (permissions, deleted channel)**
  â†’ /output_router returns 500; response lost (not retried)

## Source Files

- `gaia-web/gaia_web/main.py` _entrypoint_ [python]
- `gaia-web/gaia_web/discord_interface.py` _discord_gateway_ [python]
- `gaia-web/gaia_web/queue/message_queue.py` _sleep_wake_queue_ [python]
- `gaia-web/Dockerfile` _build_config_ [dockerfile]

## Blueprint Confidence

| Section | Confidence |
|---------|------------|
| Runtime | ðŸŸ¢ ConfidenceLevel.HIGH |
| Contract | ðŸŸ¢ ConfidenceLevel.HIGH |
| Dependencies | ðŸŸ¢ ConfidenceLevel.HIGH |
| Failure Modes | ðŸŸ¡ ConfidenceLevel.MEDIUM |
| Intent | ðŸŸ¡ ConfidenceLevel.MEDIUM |

---
_Generated automatically from `gaia-web.yaml`. Do not edit this file directly._