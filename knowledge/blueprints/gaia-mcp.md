# GAIA Service Blueprint: `gaia-mcp` (The Hands (Tool Execution))

> **Status:** ðŸŸ¢ LIVE Â· âš ï¸ genesis â€” awaiting validation  
> **Service version:** 0.5  
> **Blueprint version:** 0.2  
> **Generated by:** `manual_seed`  
> **Last reflected:** never  

## Purpose

Sandboxed execution layer enforcing security boundaries around GAIA's tool calls. Acts as both a security perimeter (preventing unauthorized file/shell access via path allowlisting) and an approval gate (requiring human confirmation for destructive operations). Delegation to a separate service allows gaia-core to remain interface-agnostic and CPU-only.


**Cognitive role:** The Hands

### Design Decisions

- Separate service decouples tool execution from cognition, keeping gaia-core CPU-only
- Path allowlisting restricts file ops to /knowledge, /sandbox, /models; symlink traversal blocked via .resolve()
- Approval flow enforces human-in-the-loop via 5-char challenge reversal; time-boxed to configurable TTL
- Domain allowlisting gates web research to trusted/reliable tiers; blocked list prevents social media leakage
- Rate limiting (20 searches/hr, 50 fetches/hr) via in-memory sliding window prevents abuse
- Study gateway pattern (async await) enables LoRA adapter management while preserving tool isolation
- Fragment assembly with overlap checking enables long responses split across token limits
- JSON-RPC 2.0 for lightweight tool dispatch without REST overhead
- Graceful degradation: missing study, blocked domains, rate limits return structured errors not exceptions

### âš ï¸ Open Questions

- Should approval TTL be configurable per-tool (e.g., ai_write longer than run_shell)?
- Should rate limits be per-minute with burst allowance instead of per-hour?
- Should approval store persist to disk across container restarts for auditability?

## Runtime

| Property | Value |
|----------|-------|
| Port | `8765` |
| Base image | `python:3.11-slim` |
| GPU | No |
| Health check | `curl -f http://localhost:8765/health` |
| Startup | `uvicorn gaia_mcp.main:app --host 0.0.0.0 --port 8765` |
| User | `${UID}:${GID}` |
| Dockerfile | `gaia-mcp/Dockerfile` |
| Compose service | `gaia-mcp` |

## Interfaces

### Inbound

- **`health`** âœ… `http_rest` `/health`  
  Container health check endpoint.
- **`root`** âœ… `http_rest` `/`  
  Root endpoint â€” returns running status message.
- **`jsonrpc_dispatch`** âœ… `http_rest` `/jsonrpc`  
  Primary tool dispatch via JSON-RPC 2.0. Handles ~30 tool methods: file I/O (read_file, write_file, ai_write), shell (run_shell), memory/vector (memory_query, memory_rebuild_index), web research (web_search, web_fetch), fragments, study gateway, Discord messaging.
- **`request_approval`** âœ… `http_rest` `/request_approval`  
  Create pending approval for sensitive tool (ai_write, write_file, run_shell, memory_rebuild_index). Returns action_id + 5-char challenge.
- **`pending_approvals`** âœ… `http_rest` `/pending_approvals`  
  List all pending approvals awaiting human confirmation.
- **`approve_action`** âœ… `http_rest` `/approve_action`  
  Approve pending action by providing reversed 5-char challenge. Dispatches underlying tool on success.

### Outbound

- **`study_gateway`** âœ… `http_rest` `/study/start`  
  Async HTTP gateway to gaia-study for LoRA training and adapter management.
- **`web_research`** âœ… `http_rest` `/`  
  External web research via DuckDuckGo (ddgs library with Instant Answer API fallback). Rate-limited: 20 searches/hr, 50 fetches/hr.
- **`discord_webhook`** âœ… `http_rest` `/`  
  Optional Discord webhook for send_discord_message tool. Requires DISCORD_WEBHOOK_URL env var.

## Service Dependencies

- **`gaia-study`** â€” lora_training_and_adapter_management Â· optional (fallback: `â€”`)

## External API Dependencies

- **duckduckgo** â€” web_search_and_fetch Â· optional
- **discord** â€” webhook_messaging Â· optional

## Volume Dependencies

- **gaia-common** `ro` â†’ `/gaia-common` â€” Shared library (tools registry, config, utils)
- **knowledge** `rw` â†’ `/knowledge` â€” Tool reference docs, system knowledge base, vector index
- **gaia-models** `ro` â†’ `/models` â€” LoRA adapters, embedding models
- **gaia-sandbox** `rw` â†’ `/sandbox` â€” Isolated workspace for tool execution

## Failure Modes

- ðŸŸ¡ **Tool execution error**
  â†’ JSON-RPC error response with code -32603 and traceback in data field
- ðŸŸ¡ **Approval timeout (>900s default TTL)**
  â†’ Pending action expires; client must request approval again
- ðŸŸ¡ **File path not in allowlist**
  â†’ ValueError; JSON-RPC error -32603 'Path not allowed'
- ðŸŸ¡ **Rate limit exceeded (web_search/web_fetch)**
  â†’ Returns ok=false with remaining count; auto-recovers after sliding window
- ðŸŸ¡ **Blocked or unknown domain in web_fetch**
  â†’ Returns ok=false with domain policy error
- ðŸŸ¡ **gaia-study unavailable**
  â†’ study_* and adapter_* tools return ok=false with error message
- ðŸŸ¡ **Sensitive tool without prior approval**
  â†’ HTTP 403 with JSON-RPC error directing to /request_approval

## Source Files

- `candidates/gaia-mcp/gaia_mcp/main.py` _entrypoint_ [python]
- `candidates/gaia-mcp/gaia_mcp/server.py` _core_dispatcher_ [python]
- `candidates/gaia-mcp/gaia_mcp/approval.py` _approval_gate_ [python]
- `candidates/gaia-mcp/gaia_mcp/web_tools.py` _web_research_ [python]
- `candidates/gaia-mcp/Dockerfile` _build_config_ [dockerfile]

## Blueprint Confidence

| Section | Confidence |
|---------|------------|
| Runtime | ðŸŸ¢ ConfidenceLevel.HIGH |
| Contract | ðŸŸ¢ ConfidenceLevel.HIGH |
| Dependencies | ðŸŸ¢ ConfidenceLevel.HIGH |
| Failure Modes | ðŸŸ¡ ConfidenceLevel.MEDIUM |
| Intent | ðŸŸ¡ ConfidenceLevel.MEDIUM |

---
_Generated automatically from `gaia-mcp.yaml`. Do not edit this file directly._