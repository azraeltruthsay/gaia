<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GAIA Mission Control</title>
  <link rel="stylesheet" href="/static/style.css">
  <!-- marked.js for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- D3.js for graph visualization -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <!-- xterm.js for terminal emulation -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/css/xterm.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0/lib/addon-fit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0/lib/addon-web-links.min.js"></script>
  <!-- Alpine.js for reactive components -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
</head>
<body>
  <header class="top-bar">
    <div class="top-bar-left">
      <span class="logo">GAIA</span>
      <span class="subtitle">Mission Control</span>
    </div>
    <div class="top-bar-right" x-data>
      <span class="badge" x-text="$store.header.serviceCount">-- services</span>
      <span :class="$store.header.pendingWarn ? 'badge badge-warn' : 'badge'" x-text="$store.header.pendingCount">-- pending</span>
      <span :class="$store.header.discordClass" :title="$store.header.discordTitle" x-text="$store.header.discordStatus">discord: --</span>
    </div>
  </header>

  <nav class="tab-bar" x-data>
    <template x-for="tab in $store.nav.tabs" :key="tab.id">
      <button class="tab"
              :class="{ active: $store.nav.currentView === tab.id }"
              @click="$store.nav.switchView(tab.id)"
              x-text="tab.label">
      </button>
    </template>
  </nav>

  <!-- â”€â”€ Dashboard View (original 3-panel layout) â”€â”€ -->
  <section class="view" x-data x-show="$store.nav.currentView === 'dashboard'" x-cloak>
    <main class="panels">
      <!-- Left: Chat -->
      <section class="panel panel-chat" x-data="chatPanel()">
        <div class="panel-header">Chat</div>
        <div class="panel-body">
          <div x-ref="messages" class="chat-messages">
            <template x-for="msg in messages" :key="msg.id">
              <div class="chat-msg" :class="msg.type" x-html="renderMessage(msg)"></div>
            </template>
          </div>
          <div class="chat-input-row">
            <input type="text" x-model="input" placeholder="Talk to GAIA..." autocomplete="off"
                   @keydown.enter.prevent="send()" :disabled="sending">
            <button @click="send()" :disabled="sending">Send</button>
          </div>
        </div>
      </section>

      <!-- Center: System State -->
      <section class="panel panel-system" x-data="systemPanel()"
               @load-component-graph.window="loadComponentGraph($event.detail.id)">
        <div class="panel-header">System State</div>
        <div class="panel-body">
          <div class="service-grid">
            <div class="state-card state-card-sleep">
              <div class="state-label">Sleep State</div>
              <div class="state-value" :class="sleepStateClass" x-text="sleepState"></div>
            </div>
            <div class="state-card">
              <div class="state-label">GPU Owner</div>
              <div class="state-value" :class="gpuOwner !== '--' ? 'ok' : ''" x-text="gpuOwner"></div>
            </div>
            <template x-for="svc in services" :key="svc.id">
              <div class="state-card" :class="{ 'state-card-candidate': svc.candidate }">
                <div class="state-label">
                  <span x-text="serviceLabel(svc.id)"></span>
                  <span x-show="svc.candidate" class="state-candidate-badge">CAND</span>
                </div>
                <div class="state-value" :class="statusClass(svc.status)" x-text="svc.status"></div>
                <div x-show="svc.latency_ms != null" class="state-latency" x-text="svc.latency_ms + 'ms'"></div>
                <div x-show="svc.id === 'discord' && svc.discord?.user" class="state-extra"
                     x-text="svc.discord ? svc.discord.user + ' Â· ' + svc.discord.guilds + ' guild' + (svc.discord.guilds !== 1 ? 's' : '') : ''"></div>
              </div>
            </template>
          </div>

          <!-- Audio Processing Widget -->
          <div class="audio-panel" x-data="audioWidget()">
            <div class="audio-header">
              <span class="audio-title">Audio Processing</span>
              <span :class="stateClass" x-text="state"></span>
              <span class="audio-gpu-badge" x-text="'GPU: ' + gpuMode"></span>
              <button class="audio-mute-btn" :class="{ muted: muted }" @click="toggleMute()" x-text="muteLabel" title="Mute/Unmute audio"></button>
            </div>
            <div class="audio-body">
              <div class="audio-gpu-bar">
                <div class="audio-vram-track"><div class="audio-vram-fill" :style="'width:' + vramPercent + '%'"></div></div>
                <span class="audio-vram-text" x-text="Math.round(vramUsed) + ' / ' + vramBudget + ' MB'"></span>
              </div>
              <div class="audio-columns">
                <div class="audio-col">
                  <div class="audio-col-header">Live Transcript</div>
                  <div class="audio-log">
                    <template x-for="entry in transcriptLog" :key="entry.id">
                      <div class="audio-log-entry" :class="entry.type">
                        <span class="audio-log-time" x-text="entry.time"></span>
                        <span class="audio-log-text" x-text="entry.text"></span>
                      </div>
                    </template>
                  </div>
                </div>
                <div class="audio-col">
                  <div class="audio-col-header">Event Log</div>
                  <div class="audio-log">
                    <template x-for="entry in eventLog" :key="entry.id">
                      <div class="audio-log-entry" :class="entry.type">
                        <span class="audio-log-time" x-text="entry.time"></span>
                        <span class="audio-log-text" x-text="entry.text"></span>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
              <div class="audio-latency-row">
                <span class="audio-latency-label">STT latency</span>
                <canvas x-ref="sttSparkline" width="120" height="24"></canvas>
                <span class="audio-latency-label">TTS latency</span>
                <canvas x-ref="ttsSparkline" width="120" height="24"></canvas>
              </div>
            </div>
          </div>

          <!-- Voice Auto-Answer Widget -->
          <div class="voice-panel" x-data="voiceWidget()">
            <div class="voice-header">
              <span class="voice-title">Voice Auto-Answer</span>
              <span :class="stateClass" x-text="state"></span>
              <button class="voice-disconnect-btn" x-show="connected" @click="disconnect()" title="Disconnect from voice">Disconnect</button>
            </div>
            <div class="voice-body">
              <div class="voice-status-row">
                <span class="voice-channel" x-text="channelName"></span>
                <span class="voice-duration" x-text="duration"></span>
              </div>
              <div class="voice-whitelist-header">
                <span>Users</span>
                <span class="voice-whitelist-hint">click to toggle auto-answer</span>
              </div>
              <div class="voice-user-list">
                <template x-for="user in users" :key="user.user_id">
                  <div class="voice-user-card" :class="{ whitelisted: user.whitelisted }"
                       @click="toggleWhitelist(user.user_id, user.whitelisted)">
                    <span class="voice-user-name" x-text="user.name"></span>
                    <span class="voice-user-badge" :class="user.whitelisted ? 'on' : 'off'"
                          x-text="user.whitelisted ? 'auto-answer' : 'off'"></span>
                  </div>
                </template>
                <template x-if="users.length === 0">
                  <div style="font-size:10px;color:var(--text-muted);padding:8px;">No users seen yet. GAIA will populate this list from Discord activity.</div>
                </template>
              </div>
            </div>
          </div>

          <div class="graph-breadcrumb">
            <span class="graph-title" x-text="graphTitle"></span>
            <span class="graph-zoom-hint">scroll to zoom</span>
            <button class="graph-back" x-show="showGraphBack" @click="backToServiceGraph()" title="Back to service graph">&larr; All Services</button>
          </div>
          <div x-ref="graphContainer" class="graph-container">
            <svg x-ref="graphSvg"></svg>
          </div>
        </div>
      </section>

      <!-- Right: Blueprints -->
      <section class="panel panel-blueprints" x-data="blueprintPanel()"
               @select-blueprint.window="selectBlueprint($event.detail.id)"
               @show-component-detail.window="showComponentDetail($event.detail)">
        <div class="panel-header">Blueprints</div>
        <div class="panel-body">
          <div class="blueprint-list">
            <template x-for="bp in blueprints" :key="bp.id">
              <div class="bp-card" :class="{ selected: bp.id === selectedId }" @click="selectBlueprint(bp.id)">
                <div class="bp-card-left">
                  <div class="bp-card-id" x-text="bp.id"></div>
                  <div class="bp-card-role" x-text="bp.role"></div>
                </div>
                <div class="bp-card-badges">
                  <span class="bp-badge" :class="bp.status === 'live' ? 'live' : 'candidate'" x-text="bp.status"></span>
                  <template x-if="bp.genesis">
                    <span class="bp-badge genesis">genesis</span>
                  </template>
                </div>
              </div>
            </template>
          </div>
          <div class="blueprint-detail" x-html="detailHtml"></div>
        </div>
      </section>
    </main>
  </section>

  <!-- â”€â”€ Commands View (Hooks Panel) â”€â”€ -->
  <section class="view" x-data x-show="$store.nav.currentView === 'hooks'" x-cloak>
    <div class="hooks-grid" x-data="hooksPanel()">

      <!-- Sleep Control -->
      <div class="hook-group">
        <div class="hook-group-header">Sleep Control</div>
        <div class="hook-status">
          <span class="hook-status-label">State:</span>
          <span class="hook-status-value" x-text="sleepState"></span>
        </div>
        <div class="hook-status">
          <span class="hook-status-label">Cycle:</span>
          <span class="hook-status-value" x-text="sleepCycle"></span>
        </div>
        <div class="hook-status">
          <span class="hook-status-label">Uptime:</span>
          <span class="hook-status-value" x-text="sleepUptime"></span>
        </div>
        <div class="hook-actions">
          <button class="hook-btn hook-btn-primary" @click="action('sleep/wake')">Wake</button>
          <button class="hook-btn hook-btn-danger" @click="action('sleep/shutdown')">Shutdown</button>
        </div>
      </div>

      <!-- GPU Management -->
      <div class="hook-group">
        <div class="hook-group-header">GPU Management</div>
        <div class="hook-status">
          <span class="hook-status-label">Owner:</span>
          <span class="hook-status-value" x-text="gpuOwner"></span>
        </div>
        <div class="hook-status">
          <span class="hook-status-label">VRAM:</span>
          <span class="hook-status-value" x-text="gpuVram"></span>
        </div>
        <div class="hook-actions">
          <button class="hook-btn hook-btn-warn" @click="action('gpu/release')">Release</button>
          <button class="hook-btn hook-btn-primary" @click="action('gpu/reclaim')">Reclaim</button>
        </div>
      </div>

      <!-- Audio Inbox -->
      <div class="hook-group" x-data="audioInboxPanel()">
        <div class="hook-group-header">Audio Inbox</div>
        <div class="hook-status">
          <span class="hook-status-label">State:</span>
          <span class="hook-status-value" x-text="inboxStateBadge"></span>
        </div>
        <div class="hook-status">
          <span class="hook-status-label">Queue:</span>
          <span class="hook-status-value" x-text="queueDepth + ' files'"></span>
        </div>
        <div class="hook-status">
          <span class="hook-status-label">Processed:</span>
          <span class="hook-status-value" x-text="filesProcessed"></span>
        </div>
        <div class="hook-actions">
          <button class="hook-btn hook-btn-primary" @click="processInbox()" :disabled="inboxBusy">Process Inbox</button>
        </div>
      </div>

      <!-- Semantic Codex -->
      <div class="hook-group hook-group-wide">
        <div class="hook-group-header">Semantic Codex Lookup</div>
        <div class="hook-search-row">
          <input type="text" x-model="codexQuery" class="hook-search-input" placeholder="Search the knowledge base..." autocomplete="off"
                 @keydown.enter.prevent="codexSearch()">
          <button class="hook-btn hook-btn-primary" @click="codexSearch()">Search</button>
        </div>
        <div class="hook-codex-results">
          <template x-if="codexSearching">
            <div class="hook-codex-placeholder">Searching...</div>
          </template>
          <template x-if="!codexSearching && codexResults.length === 0 && !codexQuery">
            <div class="hook-codex-placeholder">Enter a query to search GAIA's semantic codex.</div>
          </template>
          <template x-if="!codexSearching && codexResults.length === 0 && codexQuery && codexSearched">
            <div class="hook-codex-placeholder">No results found.</div>
          </template>
          <template x-for="r in codexResults" :key="r.id || r.title">
            <div class="hook-codex-result">
              <span x-show="r.score != null" class="hook-codex-result-score" x-text="r.score?.toFixed(3)"></span>
              <div class="hook-codex-result-title" x-text="r.title || r.key || r.id || 'untitled'"></div>
              <div class="hook-codex-result-snippet" x-text="(r.snippet || r.text || r.content || '').substring(0, 200)"></div>
            </div>
          </template>
        </div>
      </div>

      <!-- Hook Action Log -->
      <div class="hook-group hook-group-wide">
        <div class="hook-group-header">Action Log</div>
        <div class="hook-action-log">
          <template x-if="actionLog.length === 0">
            <div class="hook-log-placeholder">Actions will appear here.</div>
          </template>
          <template x-for="entry in actionLog" :key="entry.id">
            <div class="hook-log-entry" :class="entry.isError ? 'error' : 'success'">
              <span class="hook-log-time" x-text="entry.time"></span>
              <span class="hook-log-action" x-text="entry.action"></span>
              <span class="hook-log-result" x-text="entry.result"></span>
            </div>
          </template>
        </div>
      </div>

    </div>
  </section>

  <!-- â”€â”€ Files View â”€â”€ -->
  <section class="view" x-data x-show="$store.nav.currentView === 'files'" x-cloak>
    <div class="file-browser" x-data="fileBrowser()">
      <div class="fb-toolbar">
        <select class="fb-root-select" x-model="currentRoot" @change="changeRoot()">
          <template x-for="r in roots" :key="r.name">
            <option :value="r.name" x-text="r.name"></option>
          </template>
        </select>
        <div class="fb-breadcrumbs">
          <button class="fb-crumb" @click="browse(currentRoot, '')">/</button>
          <template x-for="crumb in breadcrumbs" :key="crumb.path">
            <button class="fb-crumb" @click="navigateBreadcrumb(crumb.path)" x-text="crumb.name"></button>
          </template>
        </div>
        <span class="fb-loading" x-show="loading">Loading...</span>
      </div>

      <div class="fb-error" x-show="error" x-text="error"></div>

      <!-- File listing -->
      <div class="fb-listing" x-show="!viewingFile && !loading">
        <button class="fb-entry fb-entry-up" x-show="currentPath" @click="navigateUp()">
          <span class="fb-entry-icon">..</span>
          <span class="fb-entry-name">(parent directory)</span>
        </button>
        <template x-for="entry in entries" :key="entry.name">
          <button class="fb-entry" :class="'fb-entry-' + entry.type" @click="clickEntry(entry)">
            <span class="fb-entry-icon" x-text="entry.type === 'dir' ? 'ðŸ“' : 'ðŸ“„'"></span>
            <span class="fb-entry-name" x-text="entry.name"></span>
            <span class="fb-entry-size" x-text="formatSize(entry.size)"></span>
            <span class="fb-entry-date" x-text="formatDate(entry.modified)"></span>
          </button>
        </template>
        <template x-if="!loading && entries.length === 0 && !error">
          <div class="fb-empty">Empty directory</div>
        </template>
      </div>

      <!-- File viewer -->
      <div class="fb-viewer" x-show="viewingFile">
        <div class="fb-viewer-header">
          <button class="fb-back-btn" @click="backToListing()">&larr; Back</button>
          <span class="fb-viewer-filename" x-text="fileName"></span>
          <div class="fb-editor-actions" x-show="isWritableRoot">
            <button class="fb-edit-btn" x-show="!editing" @click="enterEdit()">Edit</button>
            <button class="fb-save-btn" x-show="editing" @click="saveFile()" :disabled="saving" x-text="saving ? 'Saving...' : 'Save'"></button>
            <button class="fb-cancel-btn" x-show="editing" @click="cancelEdit()">Cancel</button>
          </div>
        </div>
        <!-- Read-only view -->
        <pre class="fb-viewer-content" x-show="!editing"><code x-text="fileContent"></code></pre>
        <!-- Editor -->
        <textarea class="fb-editor" x-show="editing" x-model="editContent"
                  @keydown.ctrl.s.prevent="saveFile()" @keydown.meta.s.prevent="saveFile()"></textarea>
      </div>
    </div>
  </section>

  <!-- â”€â”€ Knowledge View â”€â”€ -->
  <section class="view" x-data x-show="$store.nav.currentView === 'knowledge'" x-cloak>
    <div class="file-browser kb-browser" x-data="knowledgeBrowser()">
      <div class="fb-toolbar">
        <span class="kb-root-label">knowledge</span>
        <div class="fb-breadcrumbs">
          <button class="fb-crumb" @click="browse('')">/</button>
          <template x-for="crumb in breadcrumbs" :key="crumb.path">
            <button class="fb-crumb" @click="navigateBreadcrumb(crumb.path)" x-text="crumb.name"></button>
          </template>
        </div>
        <span class="fb-loading" x-show="loading">Loading...</span>
      </div>

      <div class="fb-error" x-show="error" x-text="error"></div>

      <!-- File listing -->
      <div class="fb-listing" x-show="!viewingFile && !loading">
        <button class="fb-entry fb-entry-up" x-show="currentPath" @click="navigateUp()">
          <span class="fb-entry-icon">..</span>
          <span class="fb-entry-name">(parent directory)</span>
        </button>
        <template x-for="entry in entries" :key="entry.name">
          <button class="fb-entry" :class="'fb-entry-' + entry.type" @click="clickEntry(entry)">
            <span class="fb-entry-icon" x-text="entry.type === 'dir' ? 'ðŸ“' : 'ðŸ“„'"></span>
            <span class="fb-entry-name" x-text="entry.name"></span>
            <span class="fb-entry-size" x-text="formatSize(entry.size)"></span>
          </button>
        </template>
        <template x-if="!loading && entries.length === 0 && !error">
          <div class="fb-empty">Empty directory</div>
        </template>
      </div>

      <!-- File viewer -->
      <div class="fb-viewer" x-show="viewingFile">
        <div class="fb-viewer-header">
          <button class="fb-back-btn" @click="backToListing()">&larr; Back</button>
          <span class="fb-viewer-filename" x-text="fileName"></span>
        </div>
        <!-- Markdown rendered -->
        <div class="kb-markdown blueprint-detail" x-show="isMarkdown" x-html="renderedHtml"></div>
        <!-- Plain text fallback -->
        <pre class="fb-viewer-content" x-show="!isMarkdown"><code x-text="fileContent"></code></pre>
      </div>
    </div>
  </section>

  <!-- â”€â”€ Audio Listener View â”€â”€ -->
  <section class="view" x-data x-show="$store.nav.currentView === 'audio'" x-cloak>
    <div class="al-panel" x-data="audioListenerPanel()">

      <!-- Top row: Controls + Status -->
      <div class="al-top">
        <div class="al-controls">
          <div class="al-section-header">
            <span>Listener Control</span>
            <span :class="statusBadgeClass" x-text="statusBadge"></span>
          </div>
          <div class="al-control-body">
            <div class="al-control-col">
              <div class="al-field-group">
                <span class="al-field-label">Mode</span>
                <label class="al-radio"><input type="radio" value="passive" x-model="mode"> Passive</label>
                <label class="al-radio"><input type="radio" value="active" x-model="mode"> Active</label>
              </div>
              <div class="al-field-group">
                <label class="al-checkbox"><input type="checkbox" x-model="saveAudio"> Save Audio</label>
                <label class="al-checkbox"><input type="checkbox" x-model="compress"> Compress MP3</label>
              </div>
              <div class="al-actions">
                <button class="hook-btn hook-btn-primary" @click="startListener()" :disabled="isCapturing">Start</button>
                <button class="hook-btn hook-btn-danger" @click="stopListener()" :disabled="!isCapturing">Stop</button>
              </div>
            </div>
            <div class="al-status-col">
              <div class="al-status-row">
                <span class="al-status-label">Backend</span>
                <span class="al-status-value" x-text="backend"></span>
              </div>
              <div class="al-status-row">
                <span class="al-status-label">Uptime</span>
                <span class="al-status-value" x-text="uptime"></span>
              </div>
              <div class="al-status-row">
                <span class="al-status-label">Chunks</span>
                <span class="al-status-value" x-text="chunks"></span>
              </div>
              <div class="al-status-row">
                <span class="al-status-label">Recording</span>
                <span class="al-status-value al-status-file" x-text="recordingFile"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Transcript area -->
      <div class="al-transcript-section">
        <div class="al-section-header">
          <span>Live Transcript</span>
          <button class="al-clear-btn" @click="clearTranscript()">Clear</button>
        </div>
        <div class="al-transcript">
          <template x-for="(line, idx) in transcriptLog" :key="idx">
            <div class="al-transcript-line" x-text="line"></div>
          </template>
          <template x-if="transcriptLog.length === 0">
            <div class="al-transcript-empty">No transcripts yet. Start the listener to capture audio.</div>
          </template>
        </div>
        <div class="al-ingest-row">
          <button class="hook-btn hook-btn-primary" @click="ingestTranscript()">Send to GAIA for Review</button>
          <span class="al-ingest-label">Source:</span>
          <input type="text" class="al-ingest-input" x-model="ingestSource" placeholder="Audio Listener" autocomplete="off">
        </div>
      </div>

      <!-- Action Log -->
      <div class="al-log-section">
        <div class="al-section-header">Action Log</div>
        <div class="al-action-log">
          <template x-if="actionLog.length === 0">
            <div class="hook-log-placeholder">Actions will appear here.</div>
          </template>
          <template x-for="entry in actionLog" :key="entry.id">
            <div class="hook-log-entry" :class="entry.isError ? 'error' : 'success'">
              <span class="hook-log-time" x-text="entry.time"></span>
              <span class="hook-log-action" x-text="entry.action"></span>
              <span class="hook-log-result" x-text="entry.result"></span>
            </div>
          </template>
        </div>
      </div>

    </div>
  </section>

  <!-- â”€â”€ Consent Sovereignty View â”€â”€ -->
  <section class="view" x-data x-show="$store.nav.currentView === 'consent'" x-cloak>
    <div class="ct-panel" x-data="consentPanel()">

      <!-- Top row: Stats + Tier Selector -->
      <div class="ct-top">
        <div class="ct-controls">
          <div class="al-section-header">
            <span>Consent Test Engine</span>
            <span class="ct-stats-badge" x-text="statsSummary"></span>
          </div>
          <div class="ct-control-body">
            <div class="ct-tier-selector">
              <span class="ct-field-label">Tier</span>
              <div class="ct-tier-tabs">
                <template x-for="tier in tiers" :key="tier.key">
                  <button class="ct-tier-btn" :class="{ active: selectedTier === tier.key }"
                          @click="selectTier(tier.key)" x-text="tier.label"></button>
                </template>
              </div>
            </div>
            <div class="ct-stats-row">
              <div class="ct-stat">
                <span class="ct-stat-label">Engaged</span>
                <span class="ct-stat-value ct-stat-good" x-text="statsEngaged"></span>
              </div>
              <div class="ct-stat">
                <span class="ct-stat-label">Rule-citing</span>
                <span class="ct-stat-value ct-stat-warn" x-text="statsRuleCiting"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Library -->
      <div class="ct-library-section">
        <div class="al-section-header">
          <span>Tests â€” <span x-text="tierLabel(selectedTier)"></span></span>
          <button class="hook-btn hook-btn-primary" style="flex:0 0 auto;padding:4px 12px;font-size:11px;"
                  @click="runAllTier()" :disabled="runningTier || runningTest">
            <span x-show="!runningTier">Run All Tier</span>
            <span x-show="runningTier">Running...</span>
          </button>
        </div>
        <div class="ct-test-list">
          <template x-for="test in currentTests" :key="test.id">
            <div class="ct-test-card">
              <div class="ct-test-info">
                <span class="ct-test-id" x-text="test.id"></span>
                <span class="ct-test-prompt" x-text="truncate(test.prompt, 100)"></span>
              </div>
              <div class="ct-test-tags">
                <template x-for="tag in (test.tags || [])" :key="tag">
                  <span class="ct-tag" x-text="tag"></span>
                </template>
              </div>
              <button class="hook-btn hook-btn-primary ct-run-btn"
                      @click="runTest(test.id)"
                      :disabled="runningTest === test.id || runningTier">
                <span x-show="runningTest !== test.id">Run</span>
                <span x-show="runningTest === test.id">...</span>
              </button>
            </div>
          </template>
          <template x-if="currentTests.length === 0">
            <div class="ct-empty">No tests in this tier.</div>
          </template>
        </div>
      </div>

      <!-- Main content: Result Detail + History side by side -->
      <div class="ct-main">
        <!-- Result Detail -->
        <div class="ct-result-section">
          <div class="al-section-header">
            <span>Result Detail</span>
          </div>
          <template x-if="!selectedResult">
            <div class="ct-empty">Run a test to see results here.</div>
          </template>
          <template x-if="selectedResult">
            <div class="ct-result-detail">
              <div class="ct-result-header">
                <span class="ct-test-id" x-text="selectedResult.test_id"></span>
                <span class="ct-tier-label" x-text="tierLabel(selectedResult.tier)"></span>
                <span :class="classificationBadge(selectedResult.classification)"
                      x-text="classificationLabel(selectedResult.classification)"></span>
              </div>

              <div class="ct-result-meta">
                <span x-show="selectedResult.analysis?.identity_guardian_triggered" class="ct-meta-flag">Identity Guardian triggered</span>
                <span class="ct-meta-item">Confidence: <strong x-text="(selectedResult.analysis?.confidence ?? 0).toFixed(2)"></strong></span>
                <span class="ct-meta-item">Model: <strong x-text="selectedResult.analysis?.model_used || '--'"></strong></span>
              </div>

              <div class="ct-result-block">
                <div class="ct-result-block-label">Prompt</div>
                <div class="ct-result-block-content" x-text="selectedResult.prompt"></div>
              </div>

              <div class="ct-result-block">
                <div class="ct-result-block-label">Evaluation Focus</div>
                <div class="ct-result-block-content ct-muted" x-text="selectedResult.evaluation_focus"></div>
              </div>

              <div class="ct-result-block">
                <div class="ct-result-block-label">Response</div>
                <div class="ct-result-block-content ct-response" x-text="selectedResult.actual_response || '(no response)'"></div>
              </div>

              <!-- Reasoning Quality Flags -->
              <div class="ct-flags-row" x-show="selectedResult.analysis?.reasoning_quality">
                <template x-if="selectedResult.analysis?.reasoning_quality?.green_flags_present?.length > 0">
                  <div class="ct-flags-group ct-flags-green">
                    <span class="ct-flags-label">Green Flags</span>
                    <template x-for="flag in selectedResult.analysis.reasoning_quality.green_flags_present" :key="flag">
                      <span class="ct-flag ct-flag-green" x-text="flag"></span>
                    </template>
                  </div>
                </template>
                <template x-if="selectedResult.analysis?.reasoning_quality?.red_flags_present?.length > 0">
                  <div class="ct-flags-group ct-flags-red">
                    <span class="ct-flags-label">Red Flags</span>
                    <template x-for="flag in selectedResult.analysis.reasoning_quality.red_flags_present" :key="flag">
                      <span class="ct-flag ct-flag-red" x-text="flag"></span>
                    </template>
                  </div>
                </template>
                <div class="ct-quality-indicators">
                  <span class="ct-qi" :class="selectedResult.analysis?.reasoning_quality?.engaged_with_substance ? 'ct-qi-on' : 'ct-qi-off'">Engaged</span>
                  <span class="ct-qi" :class="selectedResult.analysis?.reasoning_quality?.cited_rules_as_reasoning ? 'ct-qi-warn' : 'ct-qi-off'">Rule-citing</span>
                  <span class="ct-qi" :class="selectedResult.analysis?.reasoning_quality?.acknowledged_complexity ? 'ct-qi-on' : 'ct-qi-off'">Complexity</span>
                  <span class="ct-qi" :class="selectedResult.analysis?.reasoning_quality?.traced_broader_consequences ? 'ct-qi-on' : 'ct-qi-off'">Coherence</span>
                </div>
              </div>

              <!-- Acknowledgment -->
              <template x-if="selectedResult.acknowledgment">
                <div class="ct-result-block ct-ack-block">
                  <div class="ct-result-block-label">GAIA's Reflection (Acknowledgment)</div>
                  <div class="ct-result-block-content ct-response" x-text="selectedResult.acknowledgment.gaia_response || '(no reflection)'"></div>
                </div>
              </template>

              <!-- Action Buttons -->
              <div class="ct-result-actions">
                <button class="hook-btn hook-btn-primary"
                        @click="acknowledgeResult()"
                        :disabled="!!selectedResult.acknowledgment"
                        x-text="selectedResult.acknowledgment ? 'Acknowledged' : 'Acknowledge'">
                </button>
              </div>
            </div>
          </template>
        </div>

        <!-- Results History -->
        <div class="ct-history-section">
          <div class="al-section-header">
            <span>History</span>
          </div>
          <div class="ct-history-list">
            <template x-for="r in results" :key="r.result_id">
              <button class="ct-history-entry" :class="{ active: selectedResult?.result_id === r.result_id }"
                      @click="viewResult(r.result_id)">
                <span class="ct-history-time" x-text="formatTime(r.timestamp)"></span>
                <span class="ct-history-id" x-text="r.test_id"></span>
                <span :class="classificationBadge(r.classification)" x-text="classificationLabel(r.classification)"></span>
                <span x-show="r.has_acknowledgment" class="ct-history-ack" title="Acknowledged">ack</span>
              </button>
            </template>
            <template x-if="results.length === 0">
              <div class="ct-empty">No results yet.</div>
            </template>
          </div>
        </div>
      </div>

      <!-- Action Log -->
      <div class="ct-log-section">
        <div class="al-section-header">Action Log</div>
        <div class="al-action-log">
          <template x-if="actionLog.length === 0">
            <div class="hook-log-placeholder">Actions will appear here.</div>
          </template>
          <template x-for="entry in actionLog" :key="entry.id">
            <div class="hook-log-entry" :class="entry.isError ? 'error' : 'success'">
              <span class="hook-log-time" x-text="entry.time"></span>
              <span class="hook-log-action" x-text="entry.action"></span>
              <span class="hook-log-result" x-text="entry.result"></span>
            </div>
          </template>
        </div>
      </div>

    </div>
  </section>

  <!-- â”€â”€ Terminal View â”€â”€ -->
  <section class="view" x-data x-show="$store.nav.currentView === 'terminal'" x-cloak>
    <div class="terminal-panel" x-data="terminalPanel()">
      <div class="term-toolbar">
        <select class="term-container-select" x-model="selectedContainer" :disabled="connected">
          <option value="">Select container...</option>
          <template x-for="c in containers" :key="c.name">
            <option :value="c.name" :disabled="c.status !== 'running'" x-text="c.name + ' (' + c.status + ')'"></option>
          </template>
        </select>
        <button class="term-connect-btn" x-show="!connected" @click="connect()" :disabled="!selectedContainer || connecting" x-text="connecting ? 'Connecting...' : 'Connect'"></button>
        <button class="term-disconnect-btn" x-show="connected" @click="disconnect()">Disconnect</button>
        <button class="term-refresh-btn" @click="loadContainers()" :disabled="connected" title="Refresh container list">&#x21bb;</button>
        <span class="term-status" :class="connected ? 'term-status-on' : ''" x-text="connected ? 'Connected' : 'Disconnected'"></span>
      </div>
      <div class="term-error" x-show="error" x-text="error"></div>
      <div x-ref="termContainer" class="term-container"></div>
    </div>
  </section>

  <!-- â”€â”€ Logs View â”€â”€ -->
  <section class="view" x-data="{ logsTab: 'generation' }" x-show="$store.nav.currentView === 'logs'" x-cloak>
    <!-- Sub-tab bar -->
    <div class="logs-subtabs">
      <button class="logs-subtab" :class="logsTab === 'generation' ? 'active' : ''" @click="logsTab = 'generation'">Generation</button>
      <button class="logs-subtab" :class="logsTab === 'core' ? 'active' : ''" @click="logsTab = 'core'">Core</button>
      <button class="logs-subtab" :class="logsTab === 'web' ? 'active' : ''" @click="logsTab = 'web'">Web</button>
      <button class="logs-subtab" :class="logsTab === 'mcp' ? 'active' : ''" @click="logsTab = 'mcp'">MCP</button>
      <button class="logs-subtab" :class="logsTab === 'study' ? 'active' : ''" @click="logsTab = 'study'">Study</button>
      <button class="logs-subtab" :class="logsTab === 'audio' ? 'active' : ''" @click="logsTab = 'audio'">Audio</button>
      <button class="logs-subtab" :class="logsTab === 'discord' ? 'active' : ''" @click="logsTab = 'discord'">Discord</button>
    </div>

    <!-- Generation sub-tab (existing component, unchanged) -->
    <div x-show="logsTab === 'generation'" x-data="generationPanel()" class="gen-panel">
      <div class="gen-toolbar">
        <span class="gen-status" :class="connected ? 'gen-status-on' : ''" x-text="connected ? 'Live' : 'Disconnected'"></span>
        <button class="gen-filter-btn" :class="roleFilter === '' ? 'active' : ''" @click="setFilter('')">All</button>
        <button class="gen-filter-btn" :class="roleFilter === 'prime' ? 'active' : ''" @click="setFilter('prime')">Prime</button>
        <button class="gen-filter-btn" :class="roleFilter === 'lite' ? 'active' : ''" @click="setFilter('lite')">Lite</button>
        <div style="flex:1"></div>
        <label class="gen-scroll-lock">
          <input type="checkbox" x-model="scrollLocked"> Auto-scroll
        </label>
        <button class="gen-clear-btn" @click="clear()">Clear</button>
      </div>
      <div class="gen-output" x-ref="genOutput" @scroll="handleScroll()">
        <template x-for="(entry, idx) in entries" :key="idx">
          <div>
            <template x-if="entry.type === 'header'">
              <div class="gen-entry gen-header" :class="'gen-role-' + entry.role">
                <span class="gen-model-badge" x-text="entry.role"></span>
                <span class="gen-model-name" x-text="entry.model"></span>
                <span class="gen-phase" x-text="entry.phase"></span>
                <span class="gen-ts" x-text="entry.ts"></span>
              </div>
            </template>
            <template x-if="entry.type === 'stream'">
              <pre class="gen-entry gen-stream" x-html="entry.html"></pre>
            </template>
            <template x-if="entry.type === 'summary'">
              <div class="gen-entry gen-summary">
                <span x-text="entry.tokens + ' tokens'"></span>
                <span x-text="(entry.elapsed / 1000).toFixed(1) + 's'"></span>
                <span class="gen-tps" x-text="(entry.elapsed > 0 ? (entry.tokens / (entry.elapsed / 1000)).toFixed(1) : '?') + ' tok/s'"></span>
              </div>
            </template>
          </div>
        </template>
        <div class="gen-empty" x-show="entries.length === 0">Waiting for generation events...</div>
      </div>
    </div>

    <!-- Service log sub-tabs -->
    <template x-if="logsTab !== 'generation'">
      <div class="logs-svc-panel" x-data="serviceLogsPanel()" x-init="switchService(logsTab)" x-effect="switchService(logsTab)">
        <div class="gen-toolbar">
          <span class="gen-status" :class="connected ? 'gen-status-on' : ''" x-text="connected ? 'Live' : 'Disconnected'"></span>
          <span class="logs-svc-label" x-text="service"></span>

          <!-- Mode toggle -->
          <button class="logs-mode-btn" :class="mode === 'live' ? 'active' : ''" @click="setMode('live')">Live</button>
          <button class="logs-mode-btn" :class="mode === 'filtered' ? 'active' : ''" @click="setMode('filtered')">Filtered</button>

          <!-- Level filter toggles (visible in both modes, controls filtering in 'filtered' mode) -->
          <div class="logs-level-toggles">
            <button class="logs-lvl-btn logs-lvl-error" :class="levelFilters.error ? 'active' : ''" @click="toggleLevel('error')">ERROR</button>
            <button class="logs-lvl-btn logs-lvl-warn" :class="levelFilters.warning ? 'active' : ''" @click="toggleLevel('warning')">WARN</button>
            <button class="logs-lvl-btn logs-lvl-info" :class="levelFilters.info ? 'active' : ''" @click="toggleLevel('info')">INFO</button>
            <button class="logs-lvl-btn logs-lvl-debug" :class="levelFilters.debug ? 'active' : ''" @click="toggleLevel('debug')">DEBUG</button>
          </div>

          <div style="flex:1"></div>
          <button class="gen-clear-btn" x-show="mode === 'filtered'" @click="_fetchFiltered()">Refresh</button>
          <label class="gen-scroll-lock">
            <input type="checkbox" x-model="scrollLocked"> Auto-scroll
          </label>
          <button class="gen-clear-btn" @click="clear()">Clear</button>
        </div>
        <div class="logs-output" x-ref="logsOutput" @scroll="handleScroll()">
          <template x-for="(line, idx) in lines" :key="idx">
            <div class="logs-line" :class="'logs-level-' + line.level" x-text="line.text"></div>
          </template>
          <div class="gen-empty" x-show="lines.length === 0 && !_filterLoading" x-text="mode === 'live' ? 'Waiting for log events...' : 'No matching log lines.'"></div>
          <div class="gen-empty" x-show="_filterLoading">Loading filtered logs...</div>
        </div>
      </div>
    </template>
  </section>

  <script src="/static/app.js"></script>
</body>
</html>
